name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # 前端測試和建置
  frontend:
    name: Frontend Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Install dependencies
        working-directory: ./alumni-platform-nextjs
        run: pnpm install
      
      - name: Run linter
        working-directory: ./alumni-platform-nextjs
        run: pnpm lint --max-warnings 0
      
      - name: Run tests
        working-directory: ./alumni-platform-nextjs
        run: pnpm test --coverage --watchAll=false
      
      - name: Build application
        working-directory: ./alumni-platform-nextjs
        run: pnpm build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:5001' }}

  # 後端測試
  backend:
    name: Backend Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./alumni_platform_api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        working-directory: ./alumni_platform_api
        run: pytest tests/ -v --cov=src --cov-report=xml --cov-report=html
        env:
          SECRET_KEY: test-secret-key
          JWT_SECRET_KEY: test-jwt-secret-key
          DATABASE_URL: sqlite:///:memory:
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./alumni_platform_api/coverage.xml
          flags: backend
          name: backend-coverage

  # 整合測試（可選）
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          cd alumni_platform_api && pip install -r requirements.txt
          cd ../alumni-platform-nextjs && pnpm install
      
      - name: Start backend server
        working-directory: ./alumni_platform_api
        run: |
          python src/main_v2.py &
        env:
          SECRET_KEY: test-secret-key
          JWT_SECRET_KEY: test-jwt-secret-key
          DATABASE_URL: sqlite:///:memory:
      
      - name: Wait for backend
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:5001/api/v2/auth/me; do sleep 1; done' || exit 1
      
      - name: Run integration tests
        run: echo "Integration tests would run here"
        # 這裡可以添加實際的整合測試腳本

